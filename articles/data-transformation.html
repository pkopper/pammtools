<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Transformation • pammtools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Data Transformation">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-44545040-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-44545040-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pammtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.12</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data-transformation.html">Data transformation</a>
    </li>
    <li>
      <a href="../articles/baseline.html">Estimating the baseline hazard</a>
    </li>
    <li>
      <a href="../articles/basics.html">Basic modeling</a>
    </li>
    <li>
      <a href="../articles/convenience.html">Workflow and convenience functions</a>
    </li>
    <li>
      <a href="../articles/strata.html">Stratified models</a>
    </li>
    <li>
      <a href="../articles/splines.html">Non-linear effects (penalized splines)</a>
    </li>
    <li>
      <a href="../articles/tveffects.html">Time-varying effects (TVEs)</a>
    </li>
    <li>
      <a href="../articles/frailty.html">Frailties (random effects)</a>
    </li>
    <li>
      <a href="../articles/tdcovar.html">Time-dependent covariates (TDCs)</a>
    </li>
    <li>
      <a href="../articles/cumulative-effects.html">Cumulative effects/Exposure-Lag-Response Associations</a>
    </li>
    <li>
      <a href="../articles/smj-tutorial.html">Paper: A generalized additive model approach to time-to-event analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/adibender/pammtools">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Data Transformation</h1>
            
            <h4 class="date">2019-04-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/adibender/pammtools/blob/master/vignettes/data-transformation.Rmd"><code>vignettes/data-transformation.Rmd</code></a></small>
      <div class="hidden name"><code>data-transformation.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(pammtools)</a></code></pre></div>
<p>In this vignette we provide details on transforming data into a format suitable to fit piece-wise exponential (additive) models (PAM). Three main cases need to be distinguished</p>
<ol style="list-style-type: decimal">
<li><p><a href="data-transformation.html#data-without-time-dependent-covariates">Data without time-dependent covariates</a></p></li>
<li><p><a href="data-transformation.html#data-with-time-dependent-covariates">Data with time-dependent covariates</a></p></li>
<li><p><a href="data-transformation.html#data-with-time-dependent-covariates-with-cumulative-effects">Data with time-dependent covariates that should be modeled as cumulative effects</a></p></li>
</ol>
<div id="data-without-time-dependent-covariates" class="section level2">
<h2 class="hasAnchor">
<a href="#data-without-time-dependent-covariates" class="anchor"></a>Data without time-dependent covariates</h2>
<p>In this simple case the data transformation is relatively straight forward and handled by the <code>as_ped</code> (<strong>as</strong> <strong>p</strong>iece-wise <strong>e</strong>xponential <strong>d</strong>ata) function. This function internally calls <code><a href="https://www.rdocumentation.org/packages/survival/topics/survSplit">survival::survSplit</a></code>, thus all arguments available for the <code>survSplit</code> function are also available to the <code>as_ped</code> function.</p>
<div id="using-defaults" class="section level3">
<h3 class="hasAnchor">
<a href="#using-defaults" class="anchor"></a>Using defaults</h3>
<p>As an example data set we first consider Veterans’ Administration lung cancer study <span class="citation">(Kalbfleisch and Prentice 1980)</span> available from the <code>survival</code> package:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"veteran"</span>, <span class="dt">package =</span> <span class="st">"survival"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">veteran &lt;-<span class="st"> </span>veteran <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/dplyr_verbs.html">mutate</a></span>(</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">    <span class="dt">id    =</span> <span class="kw"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span>(),</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">    <span class="dt">trt   =</span> 1L <span class="op">*</span><span class="st"> </span>(trt <span class="op">==</span><span class="st"> </span><span class="dv">2</span>),</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">    <span class="dt">prior =</span> 1L <span class="op">*</span><span class="st"> </span>(prior <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(id, <span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">everything</a></span>())</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(veteran)</a></code></pre></div>
<pre><code>##   id trt celltype time status karno diagtime age prior
## 1  1   0 squamous   72      1    60        7  69     0
## 2  2   0 squamous  411      1    70        5  64     1
## 3  3   0 squamous  228      1    60        3  38     0
## 4  4   0 squamous  126      1    60        9  63     1
## 5  5   0 squamous  118      1    70       11  65     1
## 6  6   0 squamous   10      1    20        5  49     0</code></pre>
<p>Each row contains information on the survival time (<code>time</code>), an event indicator (<code>status</code>) and the <code>treatment</code> information (<code>6-MP</code> vs. <code>placebo</code>) as the only covariate.</p>
<p>To transform the data into piece-wise exponential data (<code>ped</code>) format, we need to</p>
<ul>
<li><p>define <span class="math inline">\(J+1\)</span> interval break points <span class="math inline">\(t_{\min} = \kappa_0 &lt; \kappa_1 &lt; \cdots &lt; \kappa_J = t_{\max}\)</span></p></li>
<li><p>create <em>pseudo</em>-observations for each interval <span class="math inline">\(j = 1,\ldots, J\)</span> in which subject <span class="math inline">\(i, i = 1,\ldots,n\)</span> was under risk.</p></li>
</ul>
<p>Using the <code>pammtools</code> package this is easily achieved with the <code>as_ped</code> function as follows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">ped &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(<span class="kw">Surv</span>(time, status)<span class="op">~</span>., <span class="dt">data =</span> veteran, <span class="dt">id =</span> <span class="st">"id"</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">ped <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">filter</a></span>(id <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">42</span>, <span class="dv">85</span>, <span class="dv">112</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(<span class="op">-</span>diagtime, <span class="op">-</span>prior)</a></code></pre></div>
<pre><code>##     id tstart tend interval    offset ped_status trt  celltype karno age
## 1   42      0    1    (0,1] 0.0000000          0   0 smallcell    50  72
## 2   42      1    2    (1,2] 0.0000000          0   0 smallcell    50  72
## 3   42      2    3    (2,3] 0.0000000          0   0 smallcell    50  72
## 4   42      3    4    (3,4] 0.0000000          0   0 smallcell    50  72
## 5   42      4    7    (4,7] 1.0986123          1   0 smallcell    50  72
## 6   85      0    1    (0,1] 0.0000000          1   1  squamous    50  35
## 7  112      0    1    (0,1] 0.0000000          0   1     adeno    60  62
## 8  112      1    2    (1,2] 0.0000000          0   1     adeno    60  62
## 9  112      2    3    (2,3] 0.0000000          0   1     adeno    60  62
## 10 112      3    4    (3,4] 0.0000000          0   1     adeno    60  62
## 11 112      4    7    (4,7] 1.0986123          0   1     adeno    60  62
## 12 112      7    8    (7,8] 0.0000000          0   1     adeno    60  62
## 13 112      8   10   (8,10] 0.6931472          0   1     adeno    60  62
## 14 112     10   11  (10,11] 0.0000000          0   1     adeno    60  62
## 15 112     11   12  (11,12] 0.0000000          0   1     adeno    60  62
## 16 112     12   13  (12,13] 0.0000000          0   1     adeno    60  62
## 17 112     13   15  (13,15] 0.6931472          0   1     adeno    60  62
## 18 112     15   16  (15,16] 0.0000000          0   1     adeno    60  62
## 19 112     16   18  (16,18] 0.6931472          0   1     adeno    60  62
## 20 112     18   19  (18,19] 0.0000000          0   1     adeno    60  62
## 21 112     19   20  (19,20] 0.0000000          0   1     adeno    60  62
## 22 112     20   21  (20,21] 0.0000000          0   1     adeno    60  62
## 23 112     21   22  (21,22] 0.0000000          0   1     adeno    60  62
## 24 112     22   24  (22,24] 0.6931472          0   1     adeno    60  62
## 25 112     24   25  (24,25] 0.0000000          0   1     adeno    60  62
## 26 112     25   27  (25,27] 0.6931472          0   1     adeno    60  62
## 27 112     27   29  (27,29] 0.6931472          0   1     adeno    60  62
## 28 112     29   30  (29,30] 0.0000000          0   1     adeno    60  62
## 29 112     30   31  (30,31] 0.0000000          0   1     adeno    60  62
## 30 112     31   33  (31,33] 0.6931472          0   1     adeno    60  62
## 31 112     33   35  (33,35] 0.6931472          0   1     adeno    60  62
## 32 112     35   36  (35,36] 0.0000000          0   1     adeno    60  62
## 33 112     36   42  (36,42] 1.7917595          0   1     adeno    60  62
## 34 112     42   43  (42,43] 0.0000000          0   1     adeno    60  62
## 35 112     43   44  (43,44] 0.0000000          0   1     adeno    60  62
## 36 112     44   45  (44,45] 0.0000000          0   1     adeno    60  62
## 37 112     45   48  (45,48] 1.0986123          0   1     adeno    60  62
## 38 112     48   49  (48,49] 0.0000000          0   1     adeno    60  62
## 39 112     49   51  (49,51] 0.6931472          1   1     adeno    60  62</code></pre>
<p>When no cut points are specified, the default is to use the unique event times. As can be seen from the above output, the function creates an <code>id</code> variable, indicating the subjects <span class="math inline">\(i = 1,\ldots,n\)</span>, with one row per <code>id</code> for each interval the subject “visited”. Thus,</p>
<ul>
<li>subject <code>42</code> was under risk during 5 intervals,</li>
<li>subject <code>85</code> was under risk during one interval,</li>
<li>and subject <code>112</code> in 33 intervals.</li>
</ul>
<p>In addition to the optional <code>id</code> variable the function also creates</p>
<ul>
<li>
<code>tstart</code>: the beginning of each interval</li>
<li>
<code>tend</code>: the end of each interval</li>
<li>
<code>interval</code>: a factor variable denoting the interval</li>
<li>
<code>offset</code>: the log of the duration during which the subject was under risk in that interval</li>
</ul>
<p>Additionally the time-constant covariates (here: <code>trt</code>, <code>celltype</code>, <code>karno</code>, etc.) are repeated <span class="math inline">\(n_i\)</span> number of times, where <span class="math inline">\(n_i\)</span> is the number of intervals during which subject <span class="math inline">\(i\)</span> was in the risk set.</p>
</div>
<div id="custom-cut-points" class="section level3">
<h3 class="hasAnchor">
<a href="#custom-cut-points" class="anchor"></a>Custom cut points</h3>
<p>Per default, the <code>as_ped</code> function uses all unique event times as cut points (which is a sensible default as for example the (cumulative) baseline hazard estimates in Cox-PH functions are also updated at event times).</p>
<p>In some cases, however, one might want to reduce the number of cut points, to reduce the size of the resulting data and/or faster estimation times. To do so the <code>cut</code> argument has to be specified. Following the above example, we can use only 4 cut points <span class="math inline">\(\kappa_0 = 0, \kappa_1 = 50, \kappa_2 = 200, \kappa_3 = 400\)</span>, resulting in <span class="math inline">\(J = 3\)</span> intervals:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">ped2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(<span class="kw">Surv</span>(time, status)<span class="op">~</span>., <span class="dt">data =</span> veteran, <span class="dt">cut =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">200</span>, <span class="dv">400</span>),</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="dt">id =</span> <span class="st">"id"</span>)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">ped2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">filter</a></span>(id <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">42</span>, <span class="dv">85</span>, <span class="dv">112</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(<span class="op">-</span>diagtime, <span class="op">-</span>prior)</a></code></pre></div>
<pre><code>##    id tstart tend interval   offset ped_status trt  celltype karno age
## 1  42      0   50   (0,50] 1.945910          1   0 smallcell    50  72
## 2  85      0   50   (0,50] 0.000000          1   1  squamous    50  35
## 3 112      0   50   (0,50] 3.912023          0   1     adeno    60  62
## 4 112     50  200 (50,200] 0.000000          1   1     adeno    60  62</code></pre>
<p>Note that now subjects <code>42</code> and <code>85</code> have only one row in the data set. The fact that subject <code>42</code> was in the risk set longer than subject <code>85</code> is, however, still accounted for by the <code>offset</code> variable. Note that the <code>offset</code>s for subject <code>85</code> and subject <code>112</code> in interval <code>(50,200]</code> are only zero because subject <code>85</code> had an observed event time of <code>1</code>, thus <code>log(1-0)=0</code> and subject <code>112</code> had an event at time <code>51</code>, thus <code>log(51-50)=0</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">veteran <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">slice</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">85</span>, <span class="dv">112</span>))</a></code></pre></div>
<pre><code>##    id trt celltype time status karno diagtime age prior
## 1  85   1 squamous    1      1    50        7  35     0
## 2 112   1    adeno   51      1    60        5  62     0</code></pre>
</div>
</div>
<div id="data-with-time-dependent-covariates" class="section level2">
<h2 class="hasAnchor">
<a href="#data-with-time-dependent-covariates" class="anchor"></a>Data with time-dependent covariates</h2>
<p>In case of data with time-dependent covariates (that should not be modeled as cumulative effects), the follow-up is usually split at desired cut-points and <em>additionally</em> at the time-points at which the TDC changes its value.</p>
<p>We assume that the data is provided in two data sets, one that contains time-to-event data and time-constant covariates and one data set that contains information of time-dependent covariates.</p>
<p>For illustration, we use the <code>pbc</code> data from the <code>survival</code> package. Before the actual data transformation we perform the data preprocessing in <code><a href="https://cran.rstudio.com/web/packages/survival/vignettes/timedep.pdf">vignette("timedep", package="survival")</a></code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"pbc"</span>, <span class="dt">package =</span> <span class="st">"survival"</span>) <span class="co"># loads pbc and pbcseq</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">pbc &lt;-<span class="st"> </span>pbc <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">filter</a></span>(id <span class="op">&lt;=</span><span class="st"> </span><span class="dv">312</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="../reference/dplyr_verbs.html">mutate</a></span>(<span class="dt">status =</span> 1L <span class="op">*</span><span class="st"> </span>(status <span class="op">==</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(id<span class="op">:</span>sex, bili, protime)</a></code></pre></div>
<p>We want to transform the data such that we could fit a concurrent effect of the time-dependent covariates <code>bili</code> and <code>protime</code>, therefore, the RHS of the formula passed to <code>as_ped</code> needs to contain an additional component, separated by <code>|</code> and all variables for which should be transformed to the concurrent format specified within the <code>concurrent</code> special. The data sets are provided within a list. In <code>concurrent</code>, we also have to specify the name of the variable which stores information on the time points at which the TDCs are updated.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">ped_pbc &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="dt">data    =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(pbc, pbcseq),</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="dt">formula =</span> <span class="kw">Surv</span>(time, status) <span class="op">~</span><span class="st"> </span>. <span class="op">|</span><span class="st"> </span><span class="kw"><a href="../reference/specials.html">concurrent</a></span>(bili, protime, <span class="dt">tz_var =</span> <span class="st">"day"</span>),</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="dt">id      =</span> <span class="st">"id"</span>)</a></code></pre></div>
<p>Multiple data sets can be provided within the list and multiple <code>concurrent</code> terms with different <code>tz_var</code> arguments can be specified with different lags. This will increase the data set, as an (additional) split point will be generated for each (lagged) time-point at which the TDC was observed:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">pbc_ped &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(<span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(pbc, pbcseq),</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  <span class="dt">formula =</span> <span class="kw">Surv</span>(time, status) <span class="op">~</span><span class="st"> </span>. <span class="op">|</span><span class="st"> </span><span class="kw"><a href="../reference/specials.html">concurrent</a></span>(bili, <span class="dt">tz_var =</span> <span class="st">"day"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/specials.html">concurrent</a></span>(protime, <span class="dt">tz_var =</span> <span class="st">"day"</span>, <span class="dt">lag =</span> <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    <span class="dt">id =</span> <span class="st">"id"</span>)</a></code></pre></div>
<p>If different <code>tz_var</code> arguments are provided, the union of both will be used as cut points in addition to usual cut points.</p>
<p><strong>Warning</strong>: For time-points on the follow up that have no observation of the TDC, the last observation will be carried forward until the next update is available.</p>
</div>
<div id="data-with-time-dependent-covariates-with-cumulative-effects" class="section level2">
<h2 class="hasAnchor">
<a href="#data-with-time-dependent-covariates-with-cumulative-effects" class="anchor"></a>Data with time-dependent covariates (with cumulative effects)</h2>
<p>Here we demonstrate data transformation of data with TDCs (<span class="math inline">\(\mathbf{z}=\{z(t_{z,q}),q=1,\ldots,Q\}\)</span>, that subsequently will be modeled as cumulative effects defined as</p>
<p><span class="math display">\[
g(\mathbf{z}, t) = \int_{\mathcal{T}(t)} h(t, t_z, z(t_z))\mathrm{d}t_z
\]</span> Here</p>
<ul>
<li>the three-variate function <span class="math inline">\(h(t,t_z,z(t_z))\)</span> defines the so-called <em>partial effects</em> of the TDC <span class="math inline">\(z(t_z)\)</span> observed at exposure time <span class="math inline">\(t_z\)</span> on the hazard at time <span class="math inline">\(t\)</span> <span class="citation">(Bender et al. 2018)</span>. The general partial effect definition given above is only one possibility, other common choices are<br> 
<ul>
<li>
<span class="math inline">\(h(t-t_z)z(t_z)\)</span> (This is the WCE model by <span class="citation">Sylvestre and Abrahamowicz (2009)</span>) <br> </li>
<li>
<span class="math inline">\(h(t-t_z, z(t_z))\)</span> (This is the DLNM model by <span class="citation">Gasparrini et al. (2017)</span>)<br> </li>
</ul>
</li>
<li><p>the cumulative effect <span class="math inline">\(g(\mathbf{z}, t)\)</span> at follow-up time <span class="math inline">\(t\)</span> is the integral (or sum) of the partial effects over exposure times <span class="math inline">\(t_z\)</span> contained within <span class="math inline">\(\mathcal{T}(t)\)</span><br> </p></li>
<li><p>the so called lag-lead window (or window of effectiveness) is denoted by <span class="math inline">\(\mathcal{T}(t)\)</span>. This represents the set of exposure times at which exposures can affect the hazard rate at time <span class="math inline">\(t\)</span>. The most common definition is <span class="math inline">\(\mathcal{T}(t) = \{t_{z,q}: t \geq t_{z,q}, q=1,\ldots, Q\}\)</span>, which means that all exposures that were observed prior to <span class="math inline">\(t\)</span> or at <span class="math inline">\(t\)</span> are eligible.</p></li>
</ul>
<p>As before we use the function <code>as_ped</code> to transform the data and additionally use the formula special <code>cumulative</code> (for <strong>fun</strong>ctional <strong>c</strong>ovariate) to specify the partial effect structure on the right-hand side of the formula.</p>
<p>Let <span class="math inline">\(t\)</span> (<code>time</code>) the follow up time, <span class="math inline">\(\mathbf{z}_1\)</span> (<code>z1</code>) and <span class="math inline">\(\mathbf{z}_2\)</span> (<code>z2</code>) two TDCs observed at different exposure time grids <span class="math inline">\(t_z\)</span> (<code>tz1</code>) and <span class="math inline">\(s_z\)</span> (<code>tz2</code>) with lag-lead windows <span class="math inline">\(\mathcal{T}_1(t) = \{t_{z,q}: t \geq t_{z,q}\}\)</span> and <span class="math inline">\(\mathcal{T}_2(t) = \{s_{z,k}: t \geq s_{z,k} + 2\}\)</span> (defined by <code>ll2 &lt;- function(t, tz) { t &gt;= tz + 2}</code>).</p>
<p>The table below gives a selection of possible partial effects and the usage of <code>cumulative</code> to create matrices needed to estimate different types of cumulative effects of <span class="math inline">\(\mathbf{z}_1\)</span> and <span class="math inline">\(\mathbf{z}_2\)</span>:</p>
<table class="table">
<colgroup>
<col width="49%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>partial effect</th>
<th>
<code>as_ped</code> specification</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(\int_{\mathcal{T}_1}h(t-t_z, z_1(t_z))\)</span></td>
<td><code><a href="../reference/specials.html">cumulative(latency(tz1), z1, tz_var= "tz1")</a></code></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\int_{\mathcal{T}_1}h(t, t-t_z, z_1(t_z))\)</span></td>
<td><code><a href="../reference/specials.html">cumulative(time, latency(tz1), z1, tz_var="tz1")</a></code></td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\int_{\mathcal{T}_1}h(t, t_z, z_1(t_z))\)</span></td>
<td><code><a href="../reference/specials.html">cumulative(time, tz1, z1, tz_var="tz1")</a></code></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\int_{\mathcal{T}_1}h(t, t_z, z_1(t_z)) + \int_{\mathcal{T}_2}h(t-s_z, z_2(s_z))\)</span></td>
<td><code>cumulative(time, tz1, z1, tz_var="tz1") + cumulative(latency(tz2), z2, tz_var="tz2", ll_fun=ll2)</code></td>
</tr>
<tr class="odd">
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>Note that</p>
<ul>
<li><p>the variable representing follow-up time <span class="math inline">\(t\)</span> in <code>cumulative</code> (here <code>time</code>) must match the time variable specified on the left-hand side of the <code>formula</code></p></li>
<li><p>the variable representing exposure time <span class="math inline">\(t_z\)</span> (here <code>tz1</code> and <code>tz2</code>) must be wrapped within <code>latency()</code> to tell <code>as_ped</code> to calculate <span class="math inline">\(t-t_z\)</span></p></li>
<li><p>by default, <span class="math inline">\(\mathcal{T}(t)\)</span> is defined as <code>function(t, tz) {t &gt;= tz}</code>, thus for <span class="math inline">\(\mathcal{T}_1\)</span> it is not necessary to explicitly specify the lag-lead window. In case you want to use a custom lag-lead window, provide the respective function to the <code>ll_fun</code> argument in <code>cumulative</code> (see <code>ll2</code> in the examples above)</p></li>
<li><p><code>cumulative</code> makes no difference between partial effects such as <span class="math inline">\(h(t-t_z, z(t_z))\)</span> and <span class="math inline">\(h(t-t_z)z(t_z)\)</span> as the necessary data transformation is the same in both cases. Later, however, when fitting the model, a distinction must be made</p></li>
<li><p>more than one <span class="math inline">\(z\)</span> variable can be provided to <code>cumulative</code>, which can be convenient if multiple covariates should have the same time components and the same lag-lead window</p></li>
<li><p>multiple <code>cumulative</code> terms can be specified, having different exposure times <code>t_z</code>, <code>s_z</code> and/or different lag-lead windows for different covariates <span class="math inline">\(\mathbf{z}_1\)</span>, <span class="math inline">\(\mathbf{z}_2\)</span></p></li>
<li><p>To tell <code>cumulative</code> which of the variables specified is the exposure time <span class="math inline">\(t_z\)</span>, the <code>tz_var</code> argument must be specified within each <code>cumulative</code> term. The follow-up time component <span class="math inline">\(t\)</span> will be automatically recognized via the left-hand side of the <code>formula</code>.</p></li>
</ul>
<div id="one-time-dependent-covariate" class="section level3">
<h3 class="hasAnchor">
<a href="#one-time-dependent-covariate" class="anchor"></a>One time-dependent covariate</h3>
<p>For illustration we use the ICU patients data sets <code>patient</code> and <code>daily</code> provided in the <strong><code>pammtools</code></strong> package, with follow-up time <code>survhosp</code> (<span class="math inline">\(t\)</span>), exposure time <code>Study_Day</code> (<span class="math inline">\(t_z\)</span>) and TDCs <code>caloriesPercentage</code> <span class="math inline">\(\mathbf{z}_1\)</span> and <code>proteinGproKG</code> (<span class="math inline">\(\mathbf{z}_2\)</span>):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(patient)</a></code></pre></div>
<pre><code>##   Year CombinedicuID CombinedID Survdays PatientDied survhosp Gender Age
## 1 2007          1114       1110     30.1           0     30.1   Male  68
## 2 2007          1114       1111     30.1           0     30.1 Female  57
## 3 2007          1114       1116      9.8           1      9.8 Female  68
## 4 2007           598       1316     30.1           0     30.1   Male  47
## 5 2007           365       1410     30.1           0     30.1   Male  69
## 6 2007           365       1414     30.1           0      5.4   Male  47
##            AdmCatID ApacheIIScore      BMI           DiagID2
## 1 Surgical Elective            20 31.60321   Cardio-Vascular
## 2           Medical            22 24.34176       Respiratory
## 3 Surgical Elective            25 17.99308   Cardio-Vascular
## 4           Medical            16 33.74653 Orthopedic/Trauma
## 5 Surgical Elective            20 38.75433       Respiratory
## 6           Medical            21 45.00622       Respiratory</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(daily)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   CombinedID Study_Day caloriesPercentage proteinGproKG
##        &lt;int&gt;     &lt;int&gt;              &lt;dbl&gt;         &lt;dbl&gt;
## 1       1110         1               0            0    
## 2       1110         2               0            0    
## 3       1110         3               4.05         0    
## 4       1110         4              35.1          0.259
## 5       1110         5              77.2          0.647
## 6       1110         6              17.3          0</code></pre>
<p>Below we illustrate the usage of <code>as_ped</code> and <code>cumulative</code> to obtain covariate matrices for the latency matrix of follow up time and exposure time and a matrix of the TDC (<code>caloriesPercentage</code>). The follow up will be split in 30 intervals with interval breaks points <code>0:30</code>. By default, the exposure time provided to <code>tz_var</code> will be used as a suffix for the names of the new matrix columns to indicate the exposure they refer to, however, you can override the suffix by specifying the <code>suffix</code> argument to <code>cumulative</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">ped &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  <span class="dt">data    =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(patient, daily),</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  <span class="dt">formula =</span> <span class="kw">Surv</span>(survhosp, PatientDied) <span class="op">~</span><span class="st"> </span>. <span class="op">|</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="st">    </span><span class="kw"><a href="../reference/specials.html">cumulative</a></span>(<span class="kw">latency</span>(Study_Day), caloriesPercentage, <span class="dt">tz_var =</span> <span class="st">"Study_Day"</span>),</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">  <span class="dt">cut     =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">30</span>,</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">  <span class="dt">id =</span> <span class="st">"CombinedID"</span>)</a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(ped, <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## Classes 'fped', 'ped' and 'data.frame':  37258 obs. of  18 variables:
##  $ CombinedID        : int  1110 1110 1110 1110 1110 1110 1110 1110 1110 1110 ...
##  $ tstart            : num  0 1 2 3 4 5 6 7 8 9 ...
##  $ tend              : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ interval          : Factor w/ 30 levels "(0,1]","(1,2]",..: 1 2 3 4 5 6 7 8 9 10 ...
##  $ offset            : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ ped_status        : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ Year              : Factor w/ 4 levels "2007","2008",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ CombinedicuID     : Factor w/ 456 levels "21","24","25",..: 355 355 355 355 355 355 355 355 355 355 ...
##  $ Survdays          : num  30.1 30.1 30.1 30.1 30.1 30.1 30.1 30.1 30.1 30.1 ...
##  $ Gender            : Factor w/ 2 levels "Female","Male": 2 2 2 2 2 2 2 2 2 2 ...
##  $ Age               : int  68 68 68 68 68 68 68 68 68 68 ...
##  $ AdmCatID          : Factor w/ 3 levels "Medical","Surgical Elective",..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ ApacheIIScore     : int  20 20 20 20 20 20 20 20 20 20 ...
##  $ BMI               : num  31.6 31.6 31.6 31.6 31.6 ...
##  $ DiagID2           : Factor w/ 9 levels "Gastrointestinal",..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ Study_Day_latency : num [1:37258, 1:12] 0 0 1 2 3 4 5 6 7 8 ...
##  $ caloriesPercentage: num [1:37258, 1:12] 0 0 0 0 0 0 0 0 0 0 ...
##   ..- attr(*, "dimnames")=List of 2
##  $ LL                : num [1:37258, 1:12] 0 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "breaks")= int  0 1 2 3 4 5 6 7 8 9 ...
##  - attr(*, "id_var")= chr "CombinedID"
##  - attr(*, "intvars")= chr  "CombinedID" "tstart" "tend" "interval" ...
##  - attr(*, "time_var")= chr "survhosp"
##  - attr(*, "func")=List of 1
##  - attr(*, "ll_funs")=List of 1
##  - attr(*, "tz")=List of 1
##  - attr(*, "tz_vars")=List of 1
##  - attr(*, "ll_weights")=List of 1
##  - attr(*, "func_mat_names")=List of 1</code></pre>
<p>As you can see, the data is transformed to the PED format as before and two additional matrix columns are added, <code>Study_Day_latency</code> and <code>caloriesPercentage</code>.<br> </p>
</div>
<div id="two-time-dependent-covariates-observed-on-the-same-exposure-time-grid" class="section level3">
<h3 class="hasAnchor">
<a href="#two-time-dependent-covariates-observed-on-the-same-exposure-time-grid" class="anchor"></a>Two time-dependent covariates observed on the same exposure time grid</h3>
<p>Using the same data, we show a slightly more complex example with two functional covariate terms with partial effects <span class="math inline">\(h(t, t-t_z, z_1(t_z))\)</span> and <span class="math inline">\(h(t-t_z, z_2(t_z))\)</span>. As in the case of ICU patient data, both TDCs were observed on the same exposure time grid, we want to use the same lag-lead window and the latency term <span class="math inline">\(t-t_z\)</span> occurs in both partial effects, we only need to specify one <code>cumulative</code> term.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">ped &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="dt">data =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(patient, daily),</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  <span class="dt">formula =</span> <span class="kw">Surv</span>(survhosp, PatientDied) <span class="op">~</span><span class="st"> </span>. <span class="op">|</span></a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="st">    </span><span class="kw"><a href="../reference/specials.html">cumulative</a></span>(survhosp, <span class="kw">latency</span>(Study_Day), caloriesPercentage, proteinGproKG,</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">      <span class="dt">tz_var =</span> <span class="st">"Study_Day"</span>),</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">  <span class="dt">cut =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">30</span>,</a>
<a class="sourceLine" id="cb19-7" data-line-number="7">  <span class="dt">id =</span> <span class="st">"CombinedID"</span>)</a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(ped, <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## Classes 'fped', 'ped' and 'data.frame':  37258 obs. of  20 variables:
##  $ CombinedID        : int  1110 1110 1110 1110 1110 1110 1110 1110 1110 1110 ...
##  $ tstart            : num  0 1 2 3 4 5 6 7 8 9 ...
##  $ tend              : int  1 2 3 4 5 6 7 8 9 10 ...
##  $ interval          : Factor w/ 30 levels "(0,1]","(1,2]",..: 1 2 3 4 5 6 7 8 9 10 ...
##  $ offset            : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ ped_status        : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ Year              : Factor w/ 4 levels "2007","2008",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ CombinedicuID     : Factor w/ 456 levels "21","24","25",..: 355 355 355 355 355 355 355 355 355 355 ...
##  $ Survdays          : num  30.1 30.1 30.1 30.1 30.1 30.1 30.1 30.1 30.1 30.1 ...
##  $ Gender            : Factor w/ 2 levels "Female","Male": 2 2 2 2 2 2 2 2 2 2 ...
##  $ Age               : int  68 68 68 68 68 68 68 68 68 68 ...
##  $ AdmCatID          : Factor w/ 3 levels "Medical","Surgical Elective",..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ ApacheIIScore     : int  20 20 20 20 20 20 20 20 20 20 ...
##  $ BMI               : num  31.6 31.6 31.6 31.6 31.6 ...
##  $ DiagID2           : Factor w/ 9 levels "Gastrointestinal",..: 2 2 2 2 2 2 2 2 2 2 ...
##  $ survhosp_mat      : int [1:37258, 1:12] 0 1 2 3 4 5 6 7 8 9 ...
##  $ Study_Day_latency : num [1:37258, 1:12] 0 0 1 2 3 4 5 6 7 8 ...
##  $ caloriesPercentage: num [1:37258, 1:12] 0 0 0 0 0 0 0 0 0 0 ...
##   ..- attr(*, "dimnames")=List of 2
##  $ proteinGproKG     : num [1:37258, 1:12] 0 0 0 0 0 0 0 0 0 0 ...
##   ..- attr(*, "dimnames")=List of 2
##  $ LL                : num [1:37258, 1:12] 0 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "breaks")= int  0 1 2 3 4 5 6 7 8 9 ...
##  - attr(*, "id_var")= chr "CombinedID"
##  - attr(*, "intvars")= chr  "CombinedID" "tstart" "tend" "interval" ...
##  - attr(*, "time_var")= chr "survhosp"
##  - attr(*, "func")=List of 1
##  - attr(*, "ll_funs")=List of 1
##  - attr(*, "tz")=List of 1
##  - attr(*, "tz_vars")=List of 1
##  - attr(*, "ll_weights")=List of 1
##  - attr(*, "func_mat_names")=List of 1</code></pre>
</div>
<div id="multiple-tdcs-observed-at-different-exposure-time-grids" class="section level3">
<h3 class="hasAnchor">
<a href="#multiple-tdcs-observed-at-different-exposure-time-grids" class="anchor"></a>Multiple TDCs observed at different exposure time grids</h3>
<p>To illustrate data transformation when TDCs <span class="math inline">\(\mathbf{z}_1\)</span> and <span class="math inline">\(\mathbf{z}_2\)</span> were observed on different exposure time grids (<span class="math inline">\(t_z\)</span> and <span class="math inline">\(s_z\)</span>) and are assumed to have different lag_lead windows <span class="math inline">\(\mathcal{T}_1(t)\)</span> and <span class="math inline">\(\mathcal{T}_2(t)\)</span>, we use simulated data <code>simdf_elra</code> contained in <strong><code>pammtools</code></strong> (see example in <code>sim_pexp</code> for data generation).</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">simdf_elra</a></code></pre></div>
<pre><code>## # A tibble: 250 x 9
##       id   time status      x1    x2 tz1       z.tz1     tz2       z.tz2   
##  * &lt;int&gt;  &lt;dbl&gt;  &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;    &lt;list&gt;    &lt;list&gt;  
##  1     1  3.22       1  1.59   4.61  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  2     2 10          0 -0.530  0.178 &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  3     3  0.808      1 -2.43   3.25  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  4     4  3.04       1  0.696  1.26  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  5     5  3.36       1  2.54   3.71  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  6     6  4.07       1 -0.0231 0.607 &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  7     7  0.534      1  1.68   1.74  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  8     8  1.57       1 -1.89   2.51  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
##  9     9  2.39       1  0.126  3.38  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
## 10    10  6.61       1  1.79   1.06  &lt;int [10… &lt;dbl [10… &lt;int [11… &lt;dbl [1…
## # … with 240 more rows</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">simdf_elra <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">slice</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(id, tz1) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>()</a></code></pre></div>
<pre><code>## # A tibble: 10 x 2
##       id   tz1
##    &lt;int&gt; &lt;int&gt;
##  1     1     1
##  2     1     2
##  3     1     3
##  4     1     4
##  5     1     5
##  6     1     6
##  7     1     7
##  8     1     8
##  9     1     9
## 10     1    10</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">simdf_elra <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">slice</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">select</a></span>(id, tz2) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>()</a></code></pre></div>
<pre><code>## # A tibble: 11 x 2
##       id   tz2
##    &lt;int&gt; &lt;int&gt;
##  1     1    -5
##  2     1    -4
##  3     1    -3
##  4     1    -2
##  5     1    -1
##  6     1     0
##  7     1     1
##  8     1     2
##  9     1     3
## 10     1     4
## 11     1     5</code></pre>
<p>Note that <code>tz1</code> has a maximum length of 10, while <code>tz2</code> has a maximum length of <code>11</code> and while <code>tz1</code> was observed during the follow up, <code>tz2</code> was partially observed before the beginning of the follow up.</p>
<p>If we wanted to estimate the following cumulative effects</p>
<ul>
<li>
<span class="math inline">\(g(\mathbf{z}_1, t) = \int_{\mathcal{T}_1(t)} h(t, t-t_z, z_1(s_z))\)</span> and</li>
<li><span class="math inline">\(g(\mathbf{z}_2, t) = \int_{\mathcal{T}_2(t)} h(t-t_z, z_2(s_z))\)</span></li>
</ul>
<p>with <span class="math inline">\(\mathcal{T}_1(t) = \{t_z: t \geq t_z + 2\}\)</span> and <span class="math inline">\(\mathcal{T}_2(t) = \{s_z: t \geq s_z\}\)</span> the data transformation function must reflect the different exposure times as well as different lag-lead window specifications as illustrated below:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">ped_sim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">  <span class="dt">data =</span> simdf_elra,</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">  <span class="dt">formula =</span> <span class="kw">Surv</span>(time, status) <span class="op">~</span><span class="st"> </span>. <span class="op">|</span></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="st">    </span><span class="kw"><a href="../reference/specials.html">cumulative</a></span>(time, <span class="kw">latency</span>(tz1), z.tz1, <span class="dt">tz_var =</span> <span class="st">"tz1"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb27-5" data-line-number="5"><span class="st">    </span><span class="kw"><a href="../reference/specials.html">cumulative</a></span>(<span class="kw">latency</span>(tz2), z.tz2, <span class="dt">tz_var =</span> <span class="st">"tz2"</span>),</a>
<a class="sourceLine" id="cb27-6" data-line-number="6">  <span class="dt">cut =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb27-7" data-line-number="7">  <span class="dt">id =</span> <span class="st">"id"</span>)</a>
<a class="sourceLine" id="cb27-8" data-line-number="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(ped_sim, <span class="dv">1</span>)</a></code></pre></div>
<pre><code>## Classes 'fped', 'ped' and 'data.frame':  1004 obs. of  15 variables:
##  $ id          : int  1 1 1 1 2 2 2 2 2 2 ...
##  $ tstart      : num  0 1 2 3 0 1 2 3 4 5 ...
##  $ tend        : int  1 2 3 4 1 2 3 4 5 6 ...
##  $ interval    : Factor w/ 10 levels "(0,1]","(1,2]",..: 1 2 3 4 1 2 3 4 5 6 ...
##  $ offset      : num  0 0 0 -1.53 0 ...
##  $ ped_status  : num  0 0 0 1 0 0 0 0 0 0 ...
##  $ x1          : num  1.59 1.59 1.59 1.59 -0.53 ...
##  $ x2          : num  4.612 4.612 4.612 4.612 0.178 ...
##  $ time_tz1_mat: int [1:1004, 1:10] 0 1 2 3 0 1 2 3 4 5 ...
##  $ tz1_latency : num [1:1004, 1:10] 0 0 1 2 0 0 1 2 3 4 ...
##  $ z.tz1_tz1   : num [1:1004, 1:10] -2.014 -2.014 -2.014 -2.014 -0.978 ...
##   ..- attr(*, "dimnames")=List of 2
##  $ LL_tz1      : num [1:1004, 1:10] 0 1 1 1 0 1 1 1 1 1 ...
##  $ tz2_latency : num [1:1004, 1:11] 5 6 7 8 5 6 7 8 9 10 ...
##  $ z.tz2_tz2   : num [1:1004, 1:11] -0.689 -0.689 -0.689 -0.689 0.693 ...
##   ..- attr(*, "dimnames")=List of 2
##  $ LL_tz2      : num [1:1004, 1:11] 1 1 1 1 1 1 1 1 1 1 ...
##  - attr(*, "breaks")= int  0 1 2 3 4 5 6 7 8 9 ...
##  - attr(*, "id_var")= chr "id"
##  - attr(*, "intvars")= chr  "id" "tstart" "tend" "interval" ...
##  - attr(*, "time_var")= chr "time"
##  - attr(*, "func")=List of 2
##  - attr(*, "ll_funs")=List of 2
##  - attr(*, "tz")=List of 2
##  - attr(*, "tz_vars")=List of 2
##  - attr(*, "ll_weights")=List of 2
##  - attr(*, "func_mat_names")=List of 2</code></pre>
<p>Note how the matrix covariates associated with <code>tz1</code> have 10 columns while matrix covariates associated with <code>tz2</code> have 11 columns. Note also that the lag-lead matrices differ</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="../reference/gg_laglead.html">gg_laglead</a></span>(ped_sim)</a></code></pre></div>
<p><img src="data-transformation_files/figure-html/unnamed-chunk-15-1.png" width="600px" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Bender2018">
<p>Bender, Andreas, Fabian Scheipl, Wolfgang Hartl, Andrew G. Day, and Helmut Küchenhoff. 2018. “Penalized Estimation of Complex, Non-Linear Exposure-Lag-Response Associations.” <em>Biostatistics</em>. <a href="https://doi.org/10.1093/biostatistics/kxy003" class="uri">https://doi.org/10.1093/biostatistics/kxy003</a>.</p>
</div>
<div id="ref-Gasparrini2017">
<p>Gasparrini, Antonio, Fabian Scheipl, Ben Armstrong, and Michael G. Kenward. 2017. “A Penalized Framework for Distributed Lag Non-Linear Models.” <em>Biometrics</em> 73: 938–48. <a href="https://doi.org/10.1111/biom.12645" class="uri">https://doi.org/10.1111/biom.12645</a>.</p>
</div>
<div id="ref-Kalbfleisch1980">
<p>Kalbfleisch, J., and R. Prentice. 1980. <em>The Statistical Analysis of Failure Time Data</em>. New York: Wiley.</p>
</div>
<div id="ref-Sylvestre2009">
<p>Sylvestre, Marie-Pierre, and Michal Abrahamowicz. 2009. “Flexible Modeling of the Cumulative Effects of Time-Dependent Exposures on the Hazard.” <em>Statistics in Medicine</em> 28 (27): 3437–53. <a href="https://doi.org/10.1002/sim.3701" class="uri">https://doi.org/10.1002/sim.3701</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data-without-time-dependent-covariates">Data without time-dependent covariates</a></li>
      <li><a href="#data-with-time-dependent-covariates">Data with time-dependent covariates</a></li>
      <li><a href="#data-with-time-dependent-covariates-with-cumulative-effects">Data with time-dependent covariates (with cumulative effects)</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Andreas Bender, Fabian Scheipl.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'c3726dcbf089f0b26f496305ed030c22',
    indexName: 'pammtools',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
