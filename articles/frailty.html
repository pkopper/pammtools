<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frailty and random effects • pammtools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Frailty and random effects">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-44545040-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-44545040-3');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pammtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.12</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data-transformation.html">Data transformation</a>
    </li>
    <li>
      <a href="../articles/baseline.html">Estimating the baseline hazard</a>
    </li>
    <li>
      <a href="../articles/basics.html">Basic modeling</a>
    </li>
    <li>
      <a href="../articles/convenience.html">Workflow and convenience functions</a>
    </li>
    <li>
      <a href="../articles/strata.html">Stratified models</a>
    </li>
    <li>
      <a href="../articles/splines.html">Non-linear effects (penalized splines)</a>
    </li>
    <li>
      <a href="../articles/tveffects.html">Time-varying effects (TVEs)</a>
    </li>
    <li>
      <a href="../articles/frailty.html">Frailties (random effects)</a>
    </li>
    <li>
      <a href="../articles/tdcovar.html">Time-dependent covariates (TDCs)</a>
    </li>
    <li>
      <a href="../articles/cumulative-effects.html">Cumulative effects/Exposure-Lag-Response Associations</a>
    </li>
    <li>
      <a href="../articles/smj-tutorial.html">Paper: A generalized additive model approach to time-to-event analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/adibender/pammtools">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Frailty and random effects</h1>
            
            <h4 class="date">2019-04-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/adibender/pammtools/blob/master/vignettes/frailty.Rmd"><code>vignettes/frailty.Rmd</code></a></small>
      <div class="hidden name"><code>frailty.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(survival)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(coxme)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(pammtools)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mgcv)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/theme_get">theme_set</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>())</a></code></pre></div>
<p>Whenever subjects belonging to a cluster or group could have correlated outcomes, our models must account for such dependency structures. We can do so by including random effects in the model. In the context of survival analysis such effects are called “frailty” terms.</p>
<div id="ncctg-lung-cancer-data" class="section level2">
<h2 class="hasAnchor">
<a href="#ncctg-lung-cancer-data" class="anchor"></a>NCCTG Lung Cancer Data</h2>
<p>For illustration we consider the NCTG Lung Cancer Data <span class="citation">(Loprinzi et al. 1994)</span> that is contained in the <code>survival</code> package <span class="citation">(Terry M. Therneau and Patricia M. Grambsch 2000)</span>. A description of the data is provided in <code><a href="https://www.rdocumentation.org/packages/survival/topics/lung">?lung</a></code>.</p>
<p>The data contain survival times (in days) of advanced lung cancer patients from different institutions:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">lung &lt;-<span class="st"> </span>lung <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">mutate</a></span>(<span class="dt">inst =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(inst))</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(lung)</a></code></pre></div>
<pre><code>##   inst time status age sex ph.ecog ph.karno pat.karno meal.cal wt.loss
## 1    3  306      2  74   1       1       90       100     1175      NA
## 2    3  455      2  68   1       0       90        90     1225      15
## 3    3 1010      1  56   1       0       90        90       NA      15
## 4    5  210      2  57   1       1       90        60     1150      11
## 5    1  883      2  60   1       0      100        90       NA       0
## 6   12 1022      1  74   1       1       50        80      513       0</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">## 228 patients from 18 institutions</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(lung)</a></code></pre></div>
<pre><code>## [1] 228</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">lung <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/dplyr_verbs.html">group_by</a></span>(inst) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">n=</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/n.html">n</a></span>())</a></code></pre></div>
<pre><code>## Warning: Factor `inst` contains implicit NA, consider using
## `forcats::fct_explicit_na`</code></pre>
<pre><code>## # A tibble: 19 x 2
##    inst      n
##    &lt;fct&gt; &lt;int&gt;
##  1 1        36
##  2 2         5
##  3 3        19
##  4 4         4
##  5 5         9
##  6 6        14
##  7 7         8
##  8 10        4
##  9 11       18
## 10 12       23
## 11 13       20
## 12 15        6
## 13 16       16
## 14 21       13
## 15 22       17
## 16 26        6
## 17 32        7
## 18 33        2
## 19 &lt;NA&gt;      1</code></pre>
</div>
<div id="cox-model-with-gaussian-frailty" class="section level2">
<h2 class="hasAnchor">
<a href="#cox-model-with-gaussian-frailty" class="anchor"></a>Cox model with gaussian frailty</h2>
<p>The penalized Cox model with frailty terms has been described in <span class="citation">Therneau, Grambsch, and Pankratz (2003)</span> and implemented in the <code>coxme</code> package for Gaussian frailties. Below we apply the <code>coxme</code> function to the <code>lung</code> data:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">cme &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/coxme/topics/coxme">coxme</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/survival/topics/Surv">Surv</a></span>(time, status) <span class="op">~</span><span class="st"> </span>ph.ecog <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>inst), <span class="dt">data=</span>lung)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(cme)</a></code></pre></div>
<pre><code>##   ph.ecog 
## 0.5073993</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(cme<span class="op">$</span>frail<span class="op">$</span>inst)</a></code></pre></div>
<pre><code>##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
## -0.102068 -0.041483 -0.009171  0.000000  0.038432  0.102873</code></pre>
<ul>
<li>The effect of <code>ph.ecog</code> was estimated to be about <code>0.5</code> on the log-hazard scale.</li>
<li>The estimated random intercepts (“frailties”") for the different institution are all relatively close to zero and have small standard deviation: <code>sd(cme$frail$inst)=</code>0.059,</li>
</ul>
</div>
<div id="pam-with-gaussian-frailty" class="section level2">
<h2 class="hasAnchor">
<a href="#pam-with-gaussian-frailty" class="anchor"></a>PAM with gaussian frailty</h2>
<p>For an equivalent model using PAMs we first transform the data set and then call <code>mgcv:::gam</code> for the fit. To include a Gaussian random effect we set the <code>bs</code> argument in the respective penalized <code><a href="https://www.rdocumentation.org/packages/mgcv/topics/s">s()</a></code> term to <code>bs='re'</code> (see description in <code><a href="https://www.rdocumentation.org/packages/mgcv/topics/smooth.terms">?smooth.terms</a></code>):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">ped &lt;-<span class="st"> </span>lung <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/as_ped.html">as_ped</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/survival/topics/Surv">Surv</a></span>(time, status)<span class="op">~</span>., <span class="dt">id=</span><span class="st">"id"</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">pam &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/mgcv/topics/gam">gam</a></span>(ped_status <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/mgcv/topics/s">s</a></span>(tend) <span class="op">+</span><span class="st"> </span>ph.ecog <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/mgcv/topics/s">s</a></span>(inst, <span class="dt">bs=</span><span class="st">"re"</span>),</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">    <span class="dt">data=</span>ped, <span class="dt">family=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/family">poisson</a></span>(), <span class="dt">offset=</span>offset)</a></code></pre></div>
<p>Comparison of the estimates of the two models shows that they are in close agreement (we use <code>tidy_re</code> from the <code>pammtools</code> package to extract random effects):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="dt">pam =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(pam)[<span class="dv">2</span>], <span class="dt">cox=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(cme))</a></code></pre></div>
<pre><code>##               pam       cox
## ph.ecog 0.4963713 0.5073993</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">re &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tidy_smooth.html">tidy_re</a></span>(pam)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(cme<span class="op">$</span>frail<span class="op">$</span>inst, re<span class="op">$</span>fit, <span class="dt">las=</span><span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"Frailty (cox)"</span>, <span class="dt">ylab=</span><span class="st">"Frailty (PAM)"</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dv">0</span>, <span class="dv">1</span>)</a></code></pre></div>
<p><img src="frailty_files/figure-html/unnamed-chunk-6-1.png" width="384" style="display: block; margin: auto;"></p>
<p>The <code>pammtools</code> package also provides a convenience function for a quantile-quantile plot of the estimated frailties to check the Gaussian assumption:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw"><a href="../reference/gg_re.html">gg_re</a></span>(pam)</a></code></pre></div>
<p><img src="frailty_files/figure-html/unnamed-chunk-7-1.png" width="384" style="display: block; margin: auto;"></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Loprinzi1994">
<p>Loprinzi, C L, J A Laurie, H S Wieand, J E Krook, P J Novotny, J W Kugler, J Bartel, M Law, M Bateman, and N E Klatt. 1994. “Prospective Evaluation of Prognostic Variables from Patient-Completed Questionnaires. North Central Cancer Treatment Group.” <em>Journal of Clinical Oncology</em> 12 (3): 601–7. <a href="https://doi.org/10.1200/JCO.1994.12.3.601" class="uri">https://doi.org/10.1200/JCO.1994.12.3.601</a>.</p>
</div>
<div id="ref-Thernau2015">
<p>Terry M. Therneau, and Patricia M. Grambsch. 2000. <em>Modeling Survival Data: Extending the Cox Model</em>. New York: Springer.</p>
</div>
<div id="ref-Thernau2003">
<p>Therneau, Terry M., Patricia M. Grambsch, and V. Shane Pankratz. 2003. “Penalized Survival Models and Frailty.” <em>Journal of Computational and Graphical Statistics</em> 12 (1): 156–75. <a href="http://www.jstor.org/stable/1391074" class="uri">http://www.jstor.org/stable/1391074</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#ncctg-lung-cancer-data">NCCTG Lung Cancer Data</a></li>
      <li><a href="#cox-model-with-gaussian-frailty">Cox model with gaussian frailty</a></li>
      <li><a href="#pam-with-gaussian-frailty">PAM with gaussian frailty</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Andreas Bender, Fabian Scheipl.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'c3726dcbf089f0b26f496305ed030c22',
    indexName: 'pammtools',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
